<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルな掲示板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* Interフォントの読み込み */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // グローバル変数からFirebase設定を取得
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebaseアプリを初期化
        // compatバージョンを使用することで、firebaseグローバルオブジェクトが利用可能になります
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const auth = firebase.auth(app);

        // Reactコンポーネントの定義
        const { useState, useEffect, createElement } = React;
        const { render } = ReactDOM;

        function App() {
            const [posts, setPosts] = useState([]);
            const [newPostContent, setNewPostContent] = useState('');
            const [userName, setUserName] = useState('');
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [showConfirmation, setShowConfirmation] = useState(false);
            const [postToDelete, setPostToDelete] = useState(null);
            const [errorMessage, setErrorMessage] = useState('');
            const [replyToPostId, setReplyToPostId] = useState(null);

            // 認証状態の監視とFirestoreの初期化
            useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setUserId(user.uid);
                        if (!userName) {
                            setUserName(`匿名ユーザー ${user.uid.substring(0, 8)}`);
                        }
                    } else {
                        try {
                            if (initialAuthToken) {
                                await auth.signInWithCustomToken(initialAuthToken);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch (error) {
                            console.error("認証エラー:", error);
                            setErrorMessage("認証に失敗しました。");
                        }
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribeAuth();
            }, [userName]);

            // 投稿のリアルタイムリスナー
            useEffect(() => {
                if (!isAuthReady || !userId) {
                    return;
                }

                const postsCollectionRef = db.collection(`artifacts/${appId}/public/data/posts`);
                const q = postsCollectionRef; // orderByはFirestoreのインデックスが必要になる場合があるため、ここでは使用しない

                const unsubscribeSnapshot = q.onSnapshot((snapshot) => {
                    const fetchedPosts = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // タイムスタンプで降順にソート (新しいものが上に来るように)
                    fetchedPosts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                    setPosts(fetchedPosts);
                }, (error) => {
                    console.error("投稿の取得エラー:", error);
                    setErrorMessage("投稿の読み込み中にエラーが発生しました。");
                });

                return () => unsubscribeSnapshot();
            }, [isAuthReady, userId]);

            const handlePostSubmit = async (e) => {
                e.preventDefault();
                if (!newPostContent.trim() || !userName.trim()) {
                    setErrorMessage("ユーザー名と内容を入力してください。");
                    return;
                }
                if (!userId) {
                    setErrorMessage("ユーザーIDが利用できません。認証が完了するまでお待ちください。");
                    return;
                }

                setErrorMessage('');

                try {
                    const postData = {
                        userId: userId,
                        userName: userName,
                        content: newPostContent,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (replyToPostId) {
                        postData.parentId = replyToPostId;
                    }

                    await db.collection(`artifacts/${appId}/public/data/posts`).add(postData);
                    setNewPostContent('');
                    setReplyToPostId(null);
                } catch (error) {
                    console.error("投稿の追加エラー:", error);
                    setErrorMessage("投稿の送信中にエラーが発生しました。");
                }
            };

            const handleDeleteClick = (postId) => {
                setPostToDelete(postId);
                setShowConfirmation(true);
            };

            const confirmDelete = async () => {
                if (!postToDelete) return;

                try {
                    await db.collection(`artifacts/${appId}/public/data/posts`).doc(postToDelete).delete();
                    setShowConfirmation(false);
                    setPostToDelete(null);
                } catch (error) {
                    console.error("投稿の削除エラー:", error);
                    setErrorMessage("投稿の削除中にエラーが発生しました。");
                }
            };

            const cancelDelete = () => {
                setShowConfirmation(false);
                setPostToDelete(null);
            };

            const handleReplyClick = (postId) => {
                setReplyToPostId(postId);
                setNewPostContent('');
            };

            const cancelReply = () => {
                setReplyToPostId(null);
                setNewPostContent('');
            };

            // JSXの代わりにReact.createElementを使用
            return createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4 font-inter' },
                createElement('div', { className: 'bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 hover:scale-[1.01]' },
                    createElement('h1', { className: 'text-4xl font-extrabold text-center text-gray-800 mb-8 tracking-tight' }, 'シンプルな掲示板'),

                    errorMessage && createElement('div', { className: 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4', role: 'alert' },
                        createElement('span', { className: 'block sm:inline' }, errorMessage)
                    ),

                    createElement('div', { className: 'mb-6' },
                        createElement('label', { htmlFor: 'userName', className: 'block text-gray-700 text-sm font-bold mb-2' }, 'ユーザー名:'),
                        createElement('input', {
                            type: 'text',
                            id: 'userName',
                            value: userName,
                            onChange: (e) => setUserName(e.target.value),
                            className: 'shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200',
                            placeholder: 'あなたの名前を入力してください'
                        }),
                        userId && createElement('p', { className: 'text-xs text-gray-500 mt-1' },
                            'あなたのユーザーID: ',
                            createElement('span', { className: 'font-mono text-blue-600 break-all' }, userId)
                        )
                    ),

                    // メイン投稿フォーム
                    !replyToPostId && createElement('form', { onSubmit: handlePostSubmit, className: 'mb-8' },
                        createElement('div', { className: 'mb-4' },
                            createElement('label', { htmlFor: 'newPost', className: 'block text-gray-700 text-sm font-bold mb-2' }, '新しい投稿:'),
                            createElement('textarea', {
                                id: 'newPost',
                                value: newPostContent,
                                onChange: (e) => setNewPostContent(e.target.value),
                                className: 'shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 h-24 resize-y transition duration-200',
                                placeholder: 'ここにメッセージを入力してください...'
                            })
                        ),
                        createElement('button', {
                            type: 'submit',
                            className: 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:-translate-y-0.5 hover:shadow-lg'
                        }, '投稿する')
                    ),

                    // 返信フォーム
                    replyToPostId && createElement('div', { className: 'bg-gray-50 p-6 rounded-lg shadow-inner mb-8 border border-gray-200' },
                        createElement('h3', { className: 'text-xl font-bold text-gray-700 mb-4' },
                            '返信 (投稿ID: ',
                            createElement('span', { className: 'font-mono text-blue-600' }, `${replyToPostId.substring(0, 8)}...`),
                            ')'
                        ),
                        createElement('form', { onSubmit: handlePostSubmit },
                            createElement('div', { className: 'mb-4' },
                                createElement('label', { htmlFor: 'replyContent', className: 'block text-gray-700 text-sm font-bold mb-2' }, '返信内容:'),
                                createElement('textarea', {
                                    id: 'replyContent',
                                    value: newPostContent,
                                    onChange: (e) => setNewPostContent(e.target.value),
                                    className: 'shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 h-24 resize-y transition duration-200',
                                    placeholder: 'ここに返信を入力してください...'
                                })
                            ),
                            createElement('div', { className: 'flex justify-end space-x-2' },
                                createElement('button', {
                                    type: 'submit',
                                    className: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out'
                                }, '返信する'),
                                createElement('button', {
                                    type: 'button',
                                    onClick: cancelReply,
                                    className: 'bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-300 ease-in-out'
                                }, 'キャンセル')
                            )
                        )
                    ),

                    createElement('div', { className: 'space-y-4' },
                        posts.length === 0 && createElement('p', { className: 'text-center text-gray-500 italic' }, 'まだ投稿がありません。'),
                        posts.map((post) => createElement('div', {
                            key: post.id,
                            className: `bg-blue-50 p-5 rounded-lg shadow-md border border-blue-100 flex flex-col sm:flex-row justify-between items-start sm:items-center ${post.parentId ? 'pl-8' : ''}`
                        },
                            createElement('div', { className: 'flex-grow' },
                                post.parentId && createElement('p', { className: 'text-xs text-gray-500 mb-1 italic' },
                                    '返信先: ',
                                    createElement('span', { className: 'font-medium' }, posts.find(p => p.id === post.parentId)?.userName || '不明なユーザー'),
                                    ' (ID: ',
                                    `${post.parentId.substring(0, 8)}...`,
                                    ')'
                                ),
                                createElement('p', { className: 'text-gray-900 font-semibold text-lg break-words' }, post.content),
                                createElement('p', { className: 'text-sm text-gray-600 mt-1' },
                                    createElement('span', { className: 'font-medium' }, post.userName || '匿名ユーザー'),
                                    post.timestamp && createElement('span', { className: 'ml-2 text-xs text-gray-500' },
                                        (post.timestamp.toDate ? post.timestamp.toDate() : new Date()).toLocaleString('ja-JP')
                                    )
                                ),
                                createElement('div', { className: 'flex items-center mt-2' },
                                    post.userId === userId && createElement('button', {
                                        onClick: () => handleDeleteClick(post.id),
                                        className: 'text-red-500 hover:text-red-700 text-sm font-medium transition duration-200'
                                    }, '削除'),
                                    createElement('button', {
                                        onClick: () => handleReplyClick(post.id),
                                        className: 'text-blue-500 hover:text-blue-700 text-sm font-medium transition duration-200 ml-4'
                                    }, '返信する')
                                )
                            )
                        ))
                    ),

                    // 削除確認モーダル
                    showConfirmation && createElement('div', { className: 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50' },
                        createElement('div', { className: 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center' },
                            createElement('p', { className: 'text-lg font-semibold mb-4' }, 'この投稿を削除しますか？'),
                            createElement('div', { className: 'flex justify-center space-x-4' },
                                createElement('button', {
                                    onClick: confirmDelete,
                                    className: 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200'
                                }, 'はい'),
                                createElement('button', {
                                    onClick: cancelDelete,
                                    className: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200'
                                }, 'いいえ')
                            )
                        )
                    )
                )
            );
        }

        // root要素にAppコンポーネントをレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(createElement(App, null));
    </script>
</body>
</html>
