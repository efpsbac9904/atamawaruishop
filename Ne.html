<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON BOUNCE - LocalStorage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            touch-action: none;
        }
        canvas {
            display: block;
        }
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .interactive {
            pointer-events: auto;
        }
        #settings-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #settings-panel.open {
            transform: translateX(0);
        }
        input[type="range"] {
            accent-color: #3b82f6;
        }
        .level-up-anim {
            animation: levelUp 1s ease-out forwards;
        }
        @keyframes levelUp {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer">
        <!-- Header Info -->
        <div class="p-6 flex justify-between items-start">
            <div class="flex gap-6">
                <div>
                    <div class="text-[10px] uppercase tracking-widest text-blue-400 font-bold">Level</div>
                    <div id="level-display" class="text-3xl font-black">1</div>
                </div>
                <div>
                    <div class="text-[10px] uppercase tracking-widest text-yellow-400 font-bold">Score</div>
                    <div id="score-display" class="text-3xl font-black">0</div>
                </div>
            </div>
            <button id="settings-toggle" class="interactive p-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition">
                ⚙️
            </button>
        </div>

        <!-- Level Up Overlay -->
        <div id="level-up-overlay" class="absolute inset-0 flex items-center justify-center hidden">
            <h2 class="text-6xl font-black italic text-yellow-400 level-up-anim">LEVEL UP!</h2>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black/70 interactive">
            <h1 class="text-6xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 via-purple-500 to-fuchsia-500 mb-2">
                NEON BOUNCE
            </h1>
            <div class="mb-8 text-gray-400 text-center">
                <p>自己ベスト: <span id="best-display" class="text-white font-bold">LV.1 / 0 pts</span></p>
            </div>
            <button id="start-btn" class="px-12 py-4 bg-white text-black font-black rounded-full hover:scale-110 transition-transform">
                START GAME
            </button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over" class="absolute inset-0 flex flex-col items-center justify-center bg-black/90 hidden interactive">
            <h2 class="text-4xl font-black text-pink-500 mb-2 font-mono">CRASHED!</h2>
            <div id="final-score" class="text-7xl font-black mb-4">0</div>
            <div id="new-record" class="hidden mb-6 px-4 py-1 bg-yellow-400 text-black font-bold rounded animate-bounce">NEW RECORD!</div>
            <div class="text-gray-400 mb-10 text-sm text-center">
                今回の記録: <span id="current-result">LV.1 / 0 pts</span><br>
                自己ベスト: <span id="best-result">LV.1 / 0 pts</span>
            </div>
            <button id="restart-btn" class="px-12 py-4 border-2 border-white rounded-full font-black hover:bg-white hover:text-black transition">
                RETRY
            </button>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="absolute top-0 right-0 h-full w-64 bg-gray-900/95 border-l border-gray-700 p-6 interactive flex flex-col gap-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-xl">Config</h3>
                <button id="settings-close" class="text-gray-400">✕</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Enemy Speed</label>
                    <input type="range" id="param-speed" min="0.5" max="3" step="0.1" value="1.2" class="w-full">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Launch Power</label>
                    <input type="range" id="param-power" min="0.05" max="0.3" step="0.01" value="0.15" class="w-full">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Friction</label>
                    <input type="range" id="param-friction" min="0.90" max="0.99" step="0.01" value="0.98" class="w-full">
                </div>
            </div>
            <div class="mt-auto text-[10px] text-gray-600 text-center">
                記録はブラウザに保存されるよ。
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const scoreEl = document.getElementById('score-display');
        const levelEl = document.getElementById('level-display');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over');
        const bestDisplay = document.getElementById('best-display');
        const finalScoreEl = document.getElementById('final-score');
        const currentResultEl = document.getElementById('current-result');
        const bestResultEl = document.getElementById('best-result');
        const newRecordEl = document.getElementById('new-record');
        const levelUpOverlay = document.getElementById('level-up-overlay');

        const config = { speed: 1.2, power: 0.15, friction: 0.98 };
        let highScore = { score: 0, level: 1 };
        let gameActive = false;
        let score = 0, level = 1, combo = 1, kills = 0, frameCount = 0;
        let lastHitTime = 0;
        let width, height;

        let player = { x: 0, y: 0, r: 16, vx: 0, vy: 0, isDragging: false, dragX: 0, dragY: 0 };
        let enemies = [], particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            if (!gameActive) { player.x = width/2; player.y = height/2; }
        }
        window.addEventListener('resize', resize);
        resize();

        // LocalStorage Logic
        function loadHighScore() {
            const saved = localStorage.getItem('neon_bounce_v2');
            if (saved) {
                highScore = JSON.parse(saved);
                const text = `LV.${highScore.level} / ${highScore.score.toLocaleString()} pts`;
                bestDisplay.textContent = text;
                bestResultEl.textContent = text;
            }
        }
        loadHighScore();

        function saveHighScore() {
            if (score > highScore.score) {
                highScore = { score, level };
                localStorage.setItem('neon_bounce_v2', JSON.stringify(highScore));
                newRecordEl.classList.remove('hidden');
            } else {
                newRecordEl.classList.add('hidden');
            }
        }

        class Enemy {
            constructor() {
                this.r = 14 + Math.random() * 16;
                this.reset();
            }
            reset() {
                const side = Math.floor(Math.random() * 4);
                if (side === 0) { this.x = -this.r; this.y = Math.random() * height; }
                else if (side === 1) { this.x = width + this.r; this.y = Math.random() * height; }
                else if (side === 2) { this.x = Math.random() * width; this.y = -this.r; }
                else { this.x = Math.random() * width; this.y = height + this.r; }
                const angle = Math.atan2(player.y - this.y, player.x - this.x);
                const s = (0.5 + Math.random()) * (config.speed + (level - 1) * 0.25);
                this.vx = Math.cos(angle) * s;
                this.vy = Math.sin(angle) * s;
                this.color = `hsl(${Math.random() * 60 + 320}, 100%, 60%)`;
            }
        }

        function startGame() {
            score = 0; level = 1; kills = 0; combo = 1;
            enemies = []; particles = [];
            player.vx = 0; player.vy = 0;
            player.x = width/2; player.y = height/2;
            gameActive = true;
            scoreEl.textContent = "0";
            levelEl.textContent = "1";
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
        }

        function endGame() {
            gameActive = false;
            saveHighScore();
            finalScoreEl.textContent = score.toLocaleString();
            currentResultEl.textContent = `LV.${level} / ${score.toLocaleString()} pts`;
            loadHighScore(); // 更新されたベストを読み込み
            gameOverScreen.classList.remove('hidden');
        }

        function triggerLevelUp() {
            level++; kills = 0;
            levelEl.textContent = level;
            levelUpOverlay.classList.remove('hidden');
            setTimeout(() => levelUpOverlay.classList.add('hidden'), 1000);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
        }

        function update() {
            if (!gameActive) return;
            frameCount++;
            const spawnRate = Math.max(15, 40 - (level * 2));
            if (frameCount % spawnRate === 0) enemies.push(new Enemy());

            player.x += player.vx; player.y += player.vy;
            player.vx *= config.friction; player.vy *= config.friction;

            if (player.x < player.r || player.x > width - player.r) player.vx *= -0.7;
            if (player.y < player.r || player.y > height - player.r) player.vy *= -0.7;
            player.x = Math.max(player.r, Math.min(width - player.r, player.x));
            player.y = Math.max(player.r, Math.min(height - player.r, player.y));

            if (Date.now() - lastHitTime > 1500) combo = 1;

            enemies.forEach((e, i) => {
                e.x += e.vx; e.y += e.vy;
                const d = Math.sqrt((player.x - e.x)**2 + (player.y - e.y)**2);
                if (d < player.r + e.r) {
                    const speed = Math.sqrt(player.vx**2 + player.vy**2);
                    if (speed > 4) {
                        for(let j=0; j<15; j++) {
                            const angle = Math.random() * Math.PI * 2;
                            const f = Math.random() * 8;
                            particles.push({x: e.x, y: e.y, vx: Math.cos(angle)*f, vy: Math.sin(angle)*f, life: 1, color: e.color});
                        }
                        enemies.splice(i, 1);
                        score += 100 * combo * level;
                        combo++; kills++;
                        lastHitTime = Date.now();
                        scoreEl.textContent = score.toLocaleString();
                        if (kills >= 5) triggerLevelUp();
                    } else {
                        endGame();
                    }
                }
            });

            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                if (p.life <= 0) particles.splice(i, 1);
            });
        }

        function draw() {
            ctx.fillStyle = 'rgba(5, 5, 5, 0.3)';
            ctx.fillRect(0, 0, width, height);

            if (player.isDragging) {
                ctx.setLineDash([8, 4]);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(player.x + (player.x - player.dragX), player.y + (player.y - player.dragY));
                ctx.stroke();
                ctx.setLineDash([]);
            }

            enemies.forEach(e => {
                ctx.shadowBlur = 15; ctx.shadowColor = e.color;
                ctx.fillStyle = e.color;
                ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2); ctx.fill();
            });

            particles.forEach(p => {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI * 2); ctx.fill();
            });
            ctx.globalAlpha = 1; ctx.shadowBlur = 0;

            ctx.shadowBlur = 20; ctx.shadowColor = '#00f2ff';
            ctx.fillStyle = '#00f2ff';
            ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 0;
        }

        function loop() {
            update(); draw(); requestAnimationFrame(loop);
        }

        // Input
        function getPos(e) {
            const t = e.touches ? e.touches[0] : e;
            return { x: t.clientX, y: t.clientY };
        }
        function startDrag(e) {
            if (!gameActive) return;
            const p = getPos(e);
            if (Math.sqrt((p.x - player.x)**2 + (p.y - player.y)**2) < 80) {
                player.isDragging = true;
                player.dragX = p.x; player.dragY = p.y;
            }
        }
        function moveDrag(e) {
            if (!player.isDragging) return;
            const p = getPos(e);
            player.dragX = p.x; player.dragY = p.y;
        }
        function endDrag() {
            if (!player.isDragging) return;
            player.vx = (player.x - player.dragX) * config.power;
            player.vy = (player.y - player.dragY) * config.power;
            player.isDragging = false;
        }

        window.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', moveDrag);
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchstart', startDrag);
        window.addEventListener('touchmove', moveDrag);
        window.addEventListener('touchend', endDrag);

        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('restart-btn').onclick = startGame;
        document.getElementById('settings-toggle').onclick = () => document.getElementById('settings-panel').classList.toggle('open');
        document.getElementById('settings-close').onclick = () => document.getElementById('settings-panel').classList.remove('open');
        document.getElementById('param-speed').oninput = (e) => config.speed = parseFloat(e.target.value);
        document.getElementById('param-power').oninput = (e) => config.power = parseFloat(e.target.value);
        document.getElementById('param-friction').oninput = (e) => config.friction = parseFloat(e.target.value);

        loop();
    </script>
</body>
</html>

